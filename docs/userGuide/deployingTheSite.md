{% set title = "Deploying the Site" %}
{% set filename = "deployingTheSite" %}
<span id="title" class="d-none">{{ title }}</span>

<frontmatter>
  title: "User Guide: {{ title }}"
  layout: userGuide.md
  pageNav: default
</frontmatter>

<span id="link" class="d-none">
<md>[_User Guide → {{ title }}_]({{ filename }}.html)</md>
</span>

# {{ title }}

<span class="lead" id="overview">

**A site generated by MarkBind can be deployed by simply uploading the generated files to any Web server.** In addition, MarkBind provides several convenient deployment options.
</span>

## Generic steps for deploying a MarkBind site

1. Set the [`baseUrl` property of the `site.json` file](siteJsonFile.html#baseurl) to match the deploy location.
1. (Optional) Use the [`markbind serve` command](cliCommands.html#serve-command) to stage the site locally and confirm the contents are as expected.
1. Use the [`markbind build` command](cliCommands.html#build-command) to generate the site from source files. That command puts the generated site files in a directory named `_site` (you can change the output directory using parameters supplied to the command).
1. Upload the site files to the Web server. The sections below explain how to automate this step if you are deploying to some online platforms.


**Steps for deploying multiple MarkBind sites:**

1. Create multiple `site.json` files. Ensure that the [`baseUrl` property of each `site.json` file](siteJsonFile.html#baseurl) matches its deploy location.
1. (Optional) Use the [`markbind serve -s <file>` command](cliCommands.html#serve-command) to stage each site locally and confirm the contents are as expected.
1. For each site:
    1. Use the [`markbind build -s <file>` command](cliCommands.html#build-command) to generate the site from source files.
    1. Upload the site files to the Web server. The sections below explain how to automate this step if you are deploying to some online platforms.


## Deploying to Github Pages

**MarkBind can easily deploy a site to [Github pages](https://help.github.com/categories/github-pages-basics/)** if the project root directory is also a GitHub repo.

### Using the `markbind deploy` command

Running the **`markbind deploy`** command will deploy the most recent build of your site to the `gh-pages` branch of the repo `origin` and will be available
After the command is completed, your site will be online at `http://<username|org>.github.io/<repo>` e.g., http://se-edu.github.io/se-book.

<div id="warning-about-baseUrl">

<box type="warning">

If you are deploying to the site to GitHub pages, the `baseUrl` setting in the `site.json` should be set to the `"/<repositoryName>"` for the links in the deployed site to work correctly.<br>
{{ icon_example }} If you are using Github Pages to host your deployed website at repo `myorg/myproduct` (i.e., the website is published at `https://myorg.github.io/myproduct`), then your `baseUrl` should be `"/myproduct"`.
</box>
</div>

You can override the default deployment settings %%(e.g., repo/branch to deploy)%% in the `site.json`'s `deploy` section:

<panel type="seamless" header="**User Guide: Configuring the Site → `deploy`**" popup-url="siteJsonFile.html#deploy">

  <include src="siteJsonFile.md#site-json-deploy" />

</panel>

<br>
<box type="warning">

`markbind deploy` does not generate the static site from your source; it simply deploys the files that are already in the `_site` directory. You need to run `markbind build` first if you want to generate the site before deploying.
</box>

### Using CI Platforms
**You can setup CI Platforms to automatically build and deploy your site on GitHub Pages every time your GitHub repo is updated.**

<panel header="#### Generating a Github Personal Access Token" type="seamless" expanded>

With the exception of Github Actions, a Github Personal Access Token with **repo** permissions is required for deploying your MarkBind site to Github Pages via CI tools.

You may refer to Github's documentation on [how to generate a Github Personal Access Token](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/#creating-a-token). Ensure that you have enabled **repo** permissions as shown from the screenshot below. 

<include src="screenshot.md" boilerplate var-alt="GitHub Token Repo Permissions" var-file="githubTokenRepoPermissions.png" inline />

<box type="warning">Take note of the generated token - you will not be able to see it again once you navigate away from the page.</box>
</panel>

<panel header="#### Deploying via Github Actions" type="seamless" expanded>

To instruct [Github Actions](https://docs.github.com/en/actions) to build and deploy the site when you push to the repository, add a Github Actions workflow file in your project repo at the location `<PROJECT_ROOT>/.github/workflows/deploy.yml`  A sample workflow file is provided below:
```yml {.no-line-numbers}
name: Deploy Markbind Site
on:
  push:
    branches: master

jobs:
  build:
    runs-on: ubuntu-latest
    name: test
    env:
      GITHUB_TOKEN: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '10'
      - run: npm i -g markbind-cli
      - run: markbind build
      - run: markbind deploy --ci
```

<box type="info">

The sample `deploy.yml` workflow above uses the [default Github Token secret](https://docs.github.com/en/actions/reference/authentication-in-a-workflow) that is generated automatically for each Github Actions workflow. You may also use a [Github Personal Access Token](#generating-a-github-personal-access-token) in place of the default Github Token.
</box>

Once you have created the file, commit and push the file to your repo. Github Actions should start to build and deploy your markbind site. You can verify this by visiting `www.github.com/<org|username>/<repo>/actions`. 

For more information on customizing your workflow file to fit your specific needs, you may refer to the [Github Action Docs](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions).

</panel>

<panel header="#### Deploying via Travis CI" type="seamless" expanded>

**Adding your repository to Travis CI**

<panel header="{{icon_info}} Travis CI Migration" type="info" expanded>

Since May 2018, Travis CI has been [undergoing migration to `travis-ci.com`](https://docs.travis-ci.com/user/migrate/open-source-on-travis-ci-com/), which changes the way you setup repositories on Travis CI. 

- If you are new to Travis CI, you should **add your repository on `travis-ci.com`**.
- Alternatively, if you are already using Travis CI on `travis-ci.org`, you can continue to **add your repository on `travis-ci.org`**.
</panel>
</p>
<tabs>
  <tab header="Add your repository on `travis-ci.com`">

1. [Sign in to Travis](https://travis-ci.com/signin) using your GitHub account.
1. Accept the authorisation for Travis CI when you are redirected to GitHub.
1. Go to the [Repositories page](https://travis-ci.com/account/repositories), and click on the green _Activate_ button.<br>
  %%{{ icon_info }} If you are already using Travis CI, click on the white _Manage Repositories on GitHub_ button instead.%%
1. Select the repository with the MarkBind site, and add the Travis CI GitHub App to the repository by clicking the green _Approve and Install_ button.

  </tab>
  <tab header="Add your repository on `travis-ci.org`">

1. [Sign in to Travis](https://travis-ci.com/signin) using your GitHub account.
1. Accept the authorisation for Travis CI when you are redirected to GitHub.
1. Go to the [Repositories page](https://travis-ci.org/account/repositories).
1. Find the repository with the MarkBind site.<br>
  %%{{ icon_info }} If the organization/repository is not shown in the list, click on `Review and add` link at the bottom of the list of organization and follow the steps to give Travis access to the organization containing your repo. After that, come back to the [Repositories page](https://travis-ci.org/account/repositories) and use the `Sync Account` button to sync your Travis account with GitHub.%%
1. Activate the repo using the slider switch in front of it.

  <include src="screenshot.md" boilerplate var-alt="Activate Repo" var-file="travisActivateRepo.png" inline />

  </tab>
</tabs>

**Configuring your repository in Travis CI**

1. [Add an environment variable in Travis CI](https://docs.travis-ci.com/user/environment-variables/#defining-variables-in-repository-settings) named `GITHUB_TOKEN`, with the value set to your [generated Github Personal Access Token](#generating-a-github-personal-access-token). ==Ensure that _Display value in the build log_ is set to _Off_.==

    <include src="screenshot.md" boilerplate var-alt="Add GITHUB_TOKEN" var-file="travisGithubToken.png" inline />

1. Add a `.travis.yml` file to instruct Travis CI to build and deploy the site when you push to the repository. An example `.travis.yml` file that can accomplish this is given below:

    ```yml {.no-line-numbers}
    language: node_js
    node_js:
      - 10
    install:
      - npm i -g markbind-cli
    script: markbind build
    deploy:
      provider: script
      script: markbind deploy --ci
      skip_cleanup: true
      on:
        branch: master
    ```
More information about `.travis.yml` can be found in the [Travis CI documentation](https://docs.travis-ci.com/).

1. Commit `.travis.yml` to your MarkBind repository and push the changes. Travis CI should begin to build your site.
1. Select the MarkBind repository on [Travis CI](https://travis-ci.com/auth) and [check the build status](https://docs.travis-ci.com/user/job-lifecycle/#breaking-the-build) to see if it is successful.
1. Once the build succeeds, your MarkBind site should be online at `http://<username|org>.github.io/<repo>` e.g., http://se-edu.github.io/se-book. Travis CI will automatically build and deploy changes to your site as you push new changes to the repository after a few seconds.<br>
  %%{{ icon_info }} You might have to go to the `Settings` of your repo and configure it to publish GitHub Pages from the `gh-pages` branch as MarkBind deploys to that branch by default.%%

<box type="info" light>

**Configuring Travis CI to only deploy from a specific repository**

When Travis CI is set up as explained above, Travis CI will attempt to deploy the site from any repository it is in, including forks.
If you want Travis CI to only deploy from a specific repository (eg. only from your main site repository), you can add to the `deploy` phase a [`repo` condition in the form `owner_name/repo_name`](https://docs.travis-ci.com/user/deployment#conditional-releases-with-on).

For example, if you only want Travis CI to deploy the site when it is run from the `se-edu/se-book` repository, the following `repo` condition should be added to `.travis.yml`.

```yml {.no-line-numbers}
  on:
    branch: master
    repo: se-edu/se-book
```

The `repo` value can be changed to your specific repository as desired.
</box>

</panel>

<panel header="#### Deploying via AppVeyor CI" type="seamless" expanded>

**Adding your repository to AppVeyor CI**

1. [Sign in to AppVeyor CI](https://ci.appveyor.com/login) using your Github Account.
1. Authorize AppVeyor App as Github App in the [account settings](https://ci.appveyor.com/authorizations) by clicking on the _Install AppVeyor App_ button.

    <include src="screenshot.md" boilerplate var-alt="Install AppVeyor Github App" var-file="appveyorInstallGithubApp.png" inline />

1. In the [projects directory](https://ci.appveyor.com/projects), click on the _New Project_ button.

    <include src="screenshot.md" boilerplate var-alt="Add a new Project on AppVeyor" var-file="appveyorAddNewProject.png" inline />

1. Finally, select the repository containing your Markbind site.

**Configuring your repository in AppVeyor CI**

1. Ensure that you have generated a [Github Personal Access token with **repo** permissions](#generating-a-github-personal-access-token).
1. Navigate to the project settings page of your repository in AppVeyor CI.
1. On the left menu, click on __Environment__.
1. Under the heading __Environment variables__, add a custom environment variable named `GITHUB_TOKEN`, with the value set to the personal access token that was generated in the first step. ==Ensure that you toggle variable encryption by clicking on the padlock.== 

    <include src="screenshot.md" boilerplate var-alt="Add GitHub Token on AppVeyor" var-file="appveyorGithubToken.png" inline />

1. Remember to click __Save__ at the bottom of the page.
1. Add a `appveyor.yml`file at the root of your Markbind site's repository to instruct AppVeyor CI to build and deploy the site to Github Pages when you to push to your repository. More information on customizing `appveyor.yml` can be found in [AppVeyor documentation](https://www.appveyor.com/docs/appveyor-yml/). An example `appveyor.yml` file is given below:

    ```yml {.no-line-numbers}
    environment:
      nodejs_version: '10'
    
    branches:
      only:
        - master
    
    install:
      - ps: Install-Product node $env:nodejs_version
      - npm i -g markbind-cli
      - markbind build
      - markbind deploy --ci
    
    test: off
    
    build: off
    ```

Commit and push `appveyor.yml` to your github repository. Thereafter, AppVeyor CI should begin to run the build script. You are able to view the current build status by clicking on your repository in the [AppVeyor projects page](https://ci.appveyor.com/projects). Once the build succeeds, you should be able to view your Markbind site, after a few seconds, at `http://<username|org>.github.io/<repo>` e.g., http://se-edu.github.io/se-book. 

</panel>

<panel header="#### Deploying via Circle CI" type="seamless" expanded>

**Adding your repository to Circle CI**

1. Ensure that you have generated a [Github Personal Access Token with **repo** permissions](#generating-a-github-personal-access-token).
1. Sign in to [Circle CI](https://circleci.com/) using your Github account.
1. In the projects dashboard, click on the `Set Up Project` button beside the repo containing your Markbind site.

    <include src="screenshot.md" boilerplate var-alt="Set Up Project in Circle CI" var-file="circleCiSetUpProject.png" inline />

**Configuring your repository in Circle CI**

1. Once you have set up your project, click on the `Project Settings` button.
2. On the left, click on the `Environment Variables` tab and add a custom Environment Variable, `GITHUB_TOKEN`, which contains the value of your Github Personal Access Token.

    <include src="screenshot.md" boilerplate var-alt="Add Github Token in Circle CI" var-file="circleCiGithubToken.png" inline />

3. Commit and push a `config.yml` file to the repo containg your Markbind Site that instructs Circle CI to build and deploy your Markbind site to Github Pages whenever you push to your repository. Ensure that the `config.yml` file is located in the `<PROJECT_ROOT>/.circleci/` directory. A sample `config.yml` file is shown below:

    ```yml {.no-line-numbers}
    jobs:
      Build-And-Deploy:
        docker:
          - image: 'cimg/base:stable'
        steps:
          - checkout
          - node/install:
              node-version: "10"
              npm-version: "6"
              install-yarn: false
          - run: node --version
          - run: npm i -g markbind-cli
          - run: markbind build
          - run: markbind deploy --ci
    version: 2.1
    orbs:
      node: circleci/node@4.1.0
    workflows:
      Deploy-Markbind-Site:
        jobs:
          - Build-And-Deploy
    ```

After you have pushed the `config.yml` file to your remote repo, you should see Circle CI starting to run the Deploy job in your projects dashboard. Once it is successful, you should be able to view your Markbind site at `http://<username|org>.github.io/<repo>`. 

For more information on customizing your build script, you may refer to [Circle CI Config Reference Document](https://circleci.com/docs/2.0/configuration-reference/#section=configuration).
</panel>
<hr>

## Deploying to Netlify

**You can setup [<tooltip content="a platform for deploying static webpages (among other things)">Netlify</tooltip>](https://www.netlify.com/)
 to automatically build and deploy your site on their platform every time your GitHub repo is updated.**

Here are the steps to set up Netlify:

1. Go to https://app.netlify.com/ and sign up
1. Next go to https://app.netlify.com/account/sites and select `New site from Git`
1. Select your git provider

    <include src="screenshot.md" boilerplate var-alt="Create a new site" var-file="netlifyPreview1.png" inline />

1. Select your markbind site repository

    <include src="screenshot.md" boilerplate var-alt="Select repository" var-file="netlifyPreview2.png" inline />

1. Update the build settings as follows and hit `Deploy site`:
   - `Build Command`: `npm i markbind-cli -g && markbind build --baseUrl`
   - `Publish directory`: `_site`
   - `Show advanced`: Add a new variable with the key as `NODE_VERSION` and the value as **`10` or higher**

    </br>
    <include src="screenshot.md" boilerplate var-alt="Update build settings" var-file="netlifyPreview3.png" inline />

Now your site will be deployed on Netlify at the given address specified after deployment. It will be updated automatically when the default branch of your repo is updated.

Additionally, **when contributors make a pull request to your GitHub repo, you can _preview_ the updated site** at the bottom of the pull request by clicking on `details` link in the PR:

<include src="screenshot.md" boilerplate var-alt="Preview deploy" var-file="netlifyPreview4.png" inline />

## Relevant Tips & Tricks

<panel header="Configuring Online Deployment platforms to use specific MarkBind version" type="seamless" expand-headerless>

<include src="tipsAndTricks.md#useSpecificMarkbind" />

</panel>


{% from "njk/common.njk" import previous_next %}
{{ previous_next('themes', 'markBindInTheProjectWorkflow') }}
